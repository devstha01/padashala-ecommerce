
"use strict";!function(e){"object"==typeof module&&"object"==typeof module.exports?e(require("jquery"),window,document):e(jQuery,window,document)}(function(e,t,n,i){var s=function(t,n){this.$chartContainer=e(t),this.opts=n,this.defaultOptions={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",exportFileextension:"png",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1,zoominLimit:7,zoomoutLimit:.5}};s.prototype={init:function(t){var n=this;this.options=e.extend({},this.defaultOptions,this.opts,t);var i=this.$chartContainer;this.$chart&&this.$chart.remove();var s=this.options.data,a=this.$chart=e("<div>",{data:{options:this.options},class:"orgchart"+(""!==this.options.chartClass?" "+this.options.chartClass:"")+("t2b"!==this.options.direction?" "+this.options.direction:""),click:function(t){e(t.target).closest(".node").length||a.find(".node.focused").removeClass("focused")}});if("undefined"!=typeof MutationObserver){var o=new MutationObserver(function(e){o.disconnect();e:for(var t=0;t<e.length;t++)for(var i=0;i<e[t].addedNodes.length;i++)if(e[t].addedNodes[i].classList.contains("orgchart")&&n.options.initCompleted&&"function"==typeof n.options.initCompleted){n.options.initCompleted(a),a.triggerHandler({type:"init.orgchart"});break e}});o.observe(i[0],{childList:!0})}if("object"===e.type(s)?s instanceof e?this.buildHierarchy(a,this.buildJsonDS(s.children()),0,this.options):this.buildHierarchy(a,this.options.ajaxURL?s:this.attachRel(s,"00"),0,this.options):e.ajax({url:s,dataType:"json",beforeSend:function(){a.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,i){n.buildHierarchy(a,n.options.ajaxURL?e:n.attachRel(e,"00"),0,n.options)}).fail(function(e,t,n){console.log(n)}).always(function(){a.children(".spinner").remove()}),i.append(a),this.options.exportButton&&!i.find(".oc-export-btn").length){var r=e("<button>",{class:"oc-export-btn"+(""!==this.options.chartClass?" "+this.options.chartClass:""),text:"Export",click:function(e){e.preventDefault(),n.export()}});i.append(r)}return this.options.pan&&this.bindPan(),this.options.zoom&&this.bindZoom(),this},setOptions:function(e,t){return"string"==typeof e&&("pan"===e&&(t?this.bindPan():this.unbindPan()),"zoom"===e&&(t?this.bindZoom():this.unbindZoom())),"object"==typeof e&&(e.data?this.init(e):(void 0!==e.pan&&(e.pan?this.bindPan():this.unbindPan()),void 0!==e.zoom&&(e.zoom?this.bindZoom():this.unbindZoom()))),this},panStartHandler:function(t){var n=e(t.delegateTarget);if(e(t.target).closest(".node").length||t.touches&&t.touches.length>1)n.data("panning",!1);else{n.css("cursor","move").data("panning",!0);var i=0,s=0,a=n.css("transform");if("none"!==a){var o=a.split(",");-1===a.indexOf("3d")?(i=parseInt(o[4]),s=parseInt(o[5])):(i=parseInt(o[12]),s=parseInt(o[13]))}var r=0,d=0;if(t.targetTouches){if(1===t.targetTouches.length)r=t.targetTouches[0].pageX-i,d=t.targetTouches[0].pageY-s;else if(t.targetTouches.length>1)return}else r=t.pageX-i,d=t.pageY-s;n.on("mousemove touchmove",function(e){if(n.data("panning")){var t=0,i=0;if(e.targetTouches){if(1===e.targetTouches.length)t=e.targetTouches[0].pageX-r,i=e.targetTouches[0].pageY-d;else if(e.targetTouches.length>1)return}else t=e.pageX-r,i=e.pageY-d;var s=n.css("transform");if("none"===s)-1===s.indexOf("3d")?n.css("transform","matrix(1, 0, 0, 1, "+t+", "+i+")"):n.css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+t+", "+i+", 0, 1)");else{var a=s.split(",");-1===s.indexOf("3d")?(a[4]=" "+t,a[5]=" "+i+")"):(a[12]=" "+t,a[13]=" "+i),n.css("transform",a.join(","))}}})}},panEndHandler:function(e){e.data.chart.data("panning")&&e.data.chart.data("panning",!1).css("cursor","default").off("mousemove")},bindPan:function(){this.$chartContainer.css("overflow","hidden"),this.$chart.on("mousedown touchstart",this.panStartHandler),e(n).on("mouseup touchend",{chart:this.$chart},this.panEndHandler)},unbindPan:function(){this.$chartContainer.css("overflow","auto"),this.$chart.off("mousedown touchstart",this.panStartHandler),e(n).off("mouseup touchend",this.panEndHandler)},zoomWheelHandler:function(e){var t=e.data.oc;e.preventDefault();var n=1+(e.originalEvent.deltaY>0?-.2:.2);t.setChartScale(t.$chart,n)},zoomStartHandler:function(e){if(e.touches&&2===e.touches.length){var t=e.data.oc;t.$chart.data("pinching",!0);var n=t.getPinchDist(e);t.$chart.data("pinchDistStart",n)}},zoomingHandler:function(e){var t=e.data.oc;if(t.$chart.data("pinching")){var n=t.getPinchDist(e);t.$chart.data("pinchDistEnd",n)}},zoomEndHandler:function(e){var t=e.data.oc;if(t.$chart.data("pinching")){t.$chart.data("pinching",!1);var n=t.$chart.data("pinchDistEnd")-t.$chart.data("pinchDistStart");n>0?t.setChartScale(t.$chart,1.2):n<0&&t.setChartScale(t.$chart,.8)}},bindZoom:function(){this.$chartContainer.on("wheel",{oc:this},this.zoomWheelHandler),this.$chartContainer.on("touchstart",{oc:this},this.zoomStartHandler),e(n).on("touchmove",{oc:this},this.zoomingHandler),e(n).on("touchend",{oc:this},this.zoomEndHandler)},unbindZoom:function(){this.$chartContainer.off("wheel",this.zoomWheelHandler),this.$chartContainer.off("touchstart",this.zoomStartHandler),e(n).off("touchmove",this.zoomingHandler),e(n).off("touchend",this.zoomEndHandler)},getPinchDist:function(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))},setChartScale:function(e,n){var i=e.data("options"),s=e.css("transform"),a="",o=1;"none"===s?e.css("transform","scale("+n+","+n+")"):(a=s.split(","),-1===s.indexOf("3d")?(o=t.parseFloat(a[3])*n)>i.zoomoutLimit&&o<i.zoominLimit&&e.css("transform",s+" scale("+n+","+n+")"):(o=t.parseFloat(a[1])*n)>i.zoomoutLimit&&o<i.zoominLimit&&e.css("transform",s+" scale3d("+n+","+n+", 1)"))},buildJsonDS:function(t){var n=this,i={name:t.contents().eq(0).text().trim(),relationship:(t.parent().parent().is("li")?"1":"0")+(t.siblings("li").length?1:0)+(t.children("ul").length?1:0)};return t[0].id&&(i.id=t[0].id),t.children("ul").children().each(function(){i.children||(i.children=[]),i.children.push(n.buildJsonDS(e(this)))}),i},attachRel:function(e,t){var n=this;return e.relationship=t+(e.children&&e.children.length>0?1:0),e.children&&e.children.forEach(function(t){n.attachRel(t,"1"+(e.children.length>1?1:0))}),e},loopChart:function(t){var n=this,i=t.find("tr:first"),s={id:i.find(".node")[0].id};return i.siblings(":last").children().each(function(){s.children||(s.children=[]),s.children.push(n.loopChart(e(this)))}),s},getHierarchy:function(e){return(e=e||this.$chart).find(".node:first")[0].id?this.loopChart(e):"Error: Nodes of orghcart to be exported must have id attribute!"},getNodeState:function(e,t){var n={};return"parent"===t?n=e.closest(".nodes").siblings(":first"):"children"===t?n=e.closest("tr").siblings():"siblings"===t&&(n=e.closest("table").parent().siblings()),n.length?n.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}},getRelatedNodes:function(e,t){return"parent"===t?e.closest(".nodes").parent().children(":first").find(".node"):"children"===t?e.closest("table").children(":last").children().find(".node:first"):"siblings"===t?e.closest("table").parent().siblings().find(".node:first"):void 0},hideParent:function(e){var t=e.closest("table").closest("tr").siblings();t.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),this.getNodeState(e,"siblings").visible&&this.hideSiblings(e);var n=t.slice(1);n.css("visibility","hidden");var i=t.eq(0).find(".node"),s=this.getNodeState(i,"parent").visible;i.length&&i.is(":visible")&&i.addClass("slide slide-down").one("transitionend",function(){i.removeClass("slide"),n.removeAttr("style"),t.addClass("hidden")}),i.length&&s&&this.hideParent(i)},showParent:function(t){var n=this,i=t.closest("table").closest("tr").siblings().removeClass("hidden");i.eq(2).children().slice(1,-1).addClass("hidden");var s=i.eq(0).find(".node")[0];this.repaint(s),e(s).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(s).removeClass("slide"),n.isInAction(t)&&n.switchVerticalArrow(t.children(".topEdge"))})},hideChildren:function(e){var t=this,n=e.closest("tr").siblings();n.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var i=n.last().find(".node:visible"),s=!!n.last().is(".verticalNodes");if(!s)var a=i.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");i.addClass("slide slide-up").eq(0).one("transitionend",function(){i.removeClass("slide"),s?n.addClass("hidden"):(a.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),n.last().find(".verticalNodes").addClass("hidden")),t.isInAction(e)&&t.switchVerticalArrow(e.children(".bottomEdge"))})},showChildren:function(e){var t=this,n=e.closest("tr").siblings(),i=!!n.is(".verticalNodes")?n.removeClass("hidden").find(".node:visible"):n.removeClass("hidden").eq(2).children().find(".node:first");this.repaint(i.get(0)),i.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){i.removeClass("slide"),t.isInAction(e)&&t.switchVerticalArrow(e.children(".bottomEdge"))})},hideSiblings:function(e,t){var n=this,i=e.closest("table").parent();i.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),t?"left"===t?i.prevAll().find(".node:visible").addClass("slide slide-right"):i.nextAll().find(".node:visible").addClass("slide slide-left"):(i.prevAll().find(".node:visible").addClass("slide slide-right"),i.nextAll().find(".node:visible").addClass("slide slide-left"));var s=i.siblings().find(".slide"),a=s.closest(".nodes").prevAll(".lines").css("visibility","hidden");s.eq(0).one("transitionend",function(){a.removeAttr("style");var o=t?"left"===t?i.prevAll(":not(.hidden)"):i.nextAll(":not(.hidden)"):i.siblings();i.closest(".nodes").prev().children(":not(.hidden)").slice(1,t?2*o.length+1:-1).addClass("hidden"),s.removeClass("slide"),o.find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up").end().find(".lines, .nodes, .verticalNodes").addClass("hidden").end().addClass("hidden"),n.isInAction(e)&&n.switchHorizontalArrow(e)})},showSiblings:function(t,n){var i=this,s=e();s=n?"left"===n?t.closest("table").parent().prevAll().removeClass("hidden"):t.closest("table").parent().nextAll().removeClass("hidden"):t.closest("table").parent().siblings().removeClass("hidden");var a=t.closest("table").closest("tr").siblings();if(n?a.eq(2).children(".hidden").slice(0,2*s.length).removeClass("hidden"):a.eq(2).children(".hidden").removeClass("hidden"),!this.getNodeState(t,"parent").visible){a.removeClass("hidden");var o=a.find(".node")[0];this.repaint(o),e(o).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}s.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(-1).one("transitionend",function(){s.find(".node:visible").removeClass("slide"),i.isInAction(t)&&(i.switchHorizontalArrow(t),t.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down"))})},startLoading:function(t,n,i){var s=n.closest(".orgchart");return(void 0===s.data("inAjax")||!0!==s.data("inAjax"))&&(t.addClass("hidden"),n.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),n.children().not(".spinner").css("opacity",.2),s.data("inAjax",!0),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!0),!0)},endLoading:function(t,n,i){var s=n.closest("div.orgchart");t.removeClass("hidden"),n.find(".spinner").remove(),n.children().removeAttr("style"),s.data("inAjax",!1),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!1)},isInAction:function(e){return e.children(".edge").attr("class").indexOf("fa-")>-1},switchVerticalArrow:function(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")},switchHorizontalArrow:function(e){var t=e.closest(".orgchart").data("options");if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||e.closest(".nodes").data("siblingsLoaded"))){var n=e.closest("table").parent().prev();n.length&&(n.is(".hidden")?e.children(".leftEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"):e.children(".leftEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"));var i=e.closest("table").parent().next();i.length&&(i.is(".hidden")?e.children(".rightEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.children(".rightEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"))}else{var s=e.closest("table").parent().siblings(),a=!!s.length&&!s.is(".hidden");e.children(".leftEdge").toggleClass("fa-chevron-right",a).toggleClass("fa-chevron-left",!a),e.children(".rightEdge").toggleClass("fa-chevron-left",a).toggleClass("fa-chevron-right",!a)}},repaint:function(e){e&&(e.style.offsetWidth=e.offsetWidth)},createNode:function(i,s,a){var o=this;i.children||(i.children=[]),e.each(i.children,function(e,t){t.parentId=i.id});var r=e.Deferred(),d=e("<div"+(a.draggable?' draggable="true"':"")+(i[a.nodeId]?' id="'+i[a.nodeId]+'"':"")+(i.parentId?' data-parent="'+i.parentId+'"':"")+">").addClass("node "+(i.className||"")+(s>=a.depth?" slide-up":""));a.nodeTemplate?d.append(a.nodeTemplate(i)):d.append('<div class="title">'+i[a.nodeTitle]+"</div>").append(void 0!==a.nodeContent?'<div class="content">'+(i[a.nodeContent]||"")+"</div>":"");var l=i.relationship||"";if(a.verticalDepth&&s+2>a.verticalDepth){if(s+1>=a.verticalDepth&&Number(l.substr(2,1))){var c=s+1>=a.depth?"plus":"minus";d.append('<i class="toggleBtn fa fa-'+c+'-square"></i>')}}else Number(l.substr(0,1))&&d.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(l.substr(1,1))&&d.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(l.substr(2,1))&&d.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+a.parentNodeSymbol+' symbol"></i>');return d.on("mouseenter mouseleave",function(t){var n=e(this),i=!1,s=n.children(".topEdge"),a=(n.children(".rightEdge"),n.children(".bottomEdge")),r=n.children(".leftEdge");"mouseenter"===t.type?(s.length&&(i=o.getNodeState(n,"parent").visible,s.toggleClass("fa-chevron-up",!i).toggleClass("fa-chevron-down",i)),a.length&&(i=o.getNodeState(n,"children").visible,a.toggleClass("fa-chevron-down",!i).toggleClass("fa-chevron-up",i)),r.length&&o.switchHorizontalArrow(n)):n.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),d.on("click",function(t){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),d.on("click",".topEdge",function(t){t.stopPropagation();var n=e(this),s=n.parent(),r=o.getNodeState(s,"parent");if(r.exist){var d=s.closest("table").closest("tr").siblings(":first").find(".node");if(d.is(".slide"))return;r.visible?(o.hideParent(s),d.one("transitionend",function(){o.isInAction(s)&&(o.switchVerticalArrow(n),o.switchHorizontalArrow(s))})):o.showParent(s)}else{var l=n.parent()[0].id;o.startLoading(n,s,a)&&e.ajax({url:e.isFunction(a.ajaxURL.parent)?a.ajaxURL.parent(i):a.ajaxURL.parent+l,dataType:"json"}).done(function(t){s.closest(".orgchart").data("inAjax")&&(e.isEmptyObject(t)||o.addParent(s,t,a))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){o.endLoading(n,s,a)})}}),d.on("click",".bottomEdge",function(t){t.stopPropagation();var n=e(this),s=n.parent(),r=o.getNodeState(s,"children");if(r.exist){if(s.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;r.visible?o.hideChildren(s):o.showChildren(s)}else{var d=n.parent()[0].id;o.startLoading(n,s,a)&&e.ajax({url:e.isFunction(a.ajaxURL.children)?a.ajaxURL.children(i):a.ajaxURL.children+d,dataType:"json"}).done(function(t,n,i){s.closest(".orgchart").data("inAjax")&&t.children.length&&o.addChildren(s,t,e.extend({},a,{depth:0}))}).fail(function(e,t,n){console.log("Failed to get children nodes data")}).always(function(){o.endLoading(n,s,a)})}}),d.on("click",".toggleBtn",function(t){var n=e(this),i=n.parent().next(),s=i.find(".node"),a=i.children().children(".node");a.is(".slide")||(n.toggleClass("fa-plus-square fa-minus-square"),s.eq(0).is(".slide-up")?(i.removeClass("hidden"),o.repaint(a.get(0)),a.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){a.removeClass("slide")})):(s.addClass("slide slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),s.closest("ul").addClass("hidden")}),s.find(".toggleBtn").removeClass("fa-minus-square").addClass("fa-plus-square")))}),d.on("click",".leftEdge, .rightEdge",function(t){t.stopPropagation();var n=e(this),s=n.parent(),r=o.getNodeState(s,"siblings");if(r.exist){if(s.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;if(a.toggleSiblingsResp){var d=s.closest("table").parent().prev(),l=s.closest("table").parent().next();n.is(".leftEdge")?d.is(".hidden")?o.showSiblings(s,"left"):o.hideSiblings(s,"left"):l.is(".hidden")?o.showSiblings(s,"right"):o.hideSiblings(s,"right")}else r.visible?o.hideSiblings(s):o.showSiblings(s)}else{var c=n.parent()[0].id,h=o.getNodeState(s,"parent").exist?e.isFunction(a.ajaxURL.siblings)?a.ajaxURL.siblings(i):a.ajaxURL.siblings+c:e.isFunction(a.ajaxURL.families)?a.ajaxURL.families(i):a.ajaxURL.families+c;o.startLoading(n,s,a)&&e.ajax({url:h,dataType:"json"}).done(function(e,t,n){s.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&o.addSiblings(s,e,a)}).fail(function(e,t,n){console.log("Failed to get sibling nodes data")}).always(function(){o.endLoading(n,s,a)})}}),a.draggable&&d.on("dragstart",function(i){var s=i.originalEvent,o=/firefox/.test(t.navigator.userAgent.toLowerCase());if(o&&s.dataTransfer.setData("text/html","hack for firefox"),"none"!==d.closest(".orgchart").css("transform")){var r,l;n.querySelector(".ghost-node")?(r=d.closest(".orgchart").children(".ghost-node").get(0),l=e(r).children().get(0)):((r=n.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("ghost-node"),l=n.createElementNS("http://www.w3.org/2000/svg","rect"),r.appendChild(l),d.closest(".orgchart").append(r));var c=d.closest(".orgchart").css("transform").split(","),h=Math.abs(t.parseFloat("t2b"===a.direction||"b2t"===a.direction?c[0].slice(c[0].indexOf("(")+1):c[1]));r.setAttribute("width",d.outerWidth(!1)),r.setAttribute("height",d.outerHeight(!1)),l.setAttribute("x",5*h),l.setAttribute("y",5*h),l.setAttribute("width",120*h),l.setAttribute("height",40*h),l.setAttribute("rx",4*h),l.setAttribute("ry",4*h),l.setAttribute("stroke-width",1*h);var p=s.offsetX*h,f=s.offsetY*h;if("l2r"===a.direction?(p=s.offsetY*h,f=s.offsetX*h):"r2l"===a.direction?(p=d.outerWidth(!1)-s.offsetY*h,f=s.offsetX*h):"b2t"===a.direction&&(p=d.outerWidth(!1)-s.offsetX*h,f=d.outerHeight(!1)-s.offsetY*h),o){l.setAttribute("fill","rgb(255, 255, 255)"),l.setAttribute("stroke","rgb(191, 0, 0)");var g=n.createElement("img");g.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(r),s.dataTransfer.setDragImage(g,p,f)}else s.dataTransfer.setDragImage(r,p,f)}var v=e(this),u=v.closest(".nodes").siblings().eq(0).find(".node:first"),b=v.closest("table").find(".node");v.closest(".orgchart").data("dragged",v).find(".node").each(function(t,n){-1===b.index(n)&&(a.dropCriteria?a.dropCriteria(v,u,e(n))&&e(n).addClass("allowedDrop"):e(n).addClass("allowedDrop"))})}).on("dragover",function(t){t.preventDefault(),e(this).is(".allowedDrop")||(t.originalEvent.dataTransfer.dropEffect="none")}).on("dragend",function(t){e(this).closest(".orgchart").find(".allowedDrop").removeClass("allowedDrop")}).on("drop",function(t){var n=e(this),i=n.closest(".orgchart"),s=i.data("dragged");i.find(".allowedDrop").removeClass("allowedDrop");var a=s.closest(".nodes").siblings().eq(0).children();if(n.closest("tr").siblings().length){var o=parseInt(n.parent().attr("colspan"))+2,r='<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>';n.closest("tr").next().addBack().children().attr("colspan",o),s.find(".horizontalEdge").length||s.append(r),n.closest("tr").siblings().eq(1).children(":last").before('<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>').end().next().append(s.closest("table").parent());var d=s.closest("table").parent().siblings().find(".node:first");1===d.length&&d.append(r)}else n.append('<i class="edge verticalEdge bottomEdge fa"></i>').parent().attr("colspan",2).parent().after('<tr class="lines"><td colspan="2"><div class="downLine"></div></td></tr><tr class="lines"><td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td></tr><tr class="nodes"></tr>').siblings(":last").append(s.find(".horizontalEdge").remove().end().closest("table").parent());var l=parseInt(a.attr("colspan"));if(l>2){a.attr("colspan",l-2).parent().next().children().attr("colspan",l-2).end().next().children().slice(1,3).remove();var c=a.parent().siblings(".nodes").children().find(".node:first");1===c.length&&c.find(".horizontalEdge").remove()}else a.removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove();i.triggerHandler({type:"nodedropped.orgchart",draggedNode:s,dragZone:a.children(),dropZone:n})}),a.createNode&&a.createNode(d,i),r.resolve(d),r.promise()},buildHierarchy:function(t,n,i,s,a){var o,r=this,d=n.children,l=!!d&&d.length,c=!!(s.verticalDepth&&i+1>=s.verticalDepth);if(Object.keys(n).length>1&&(o=c?t:e("<table>"),c||t.append(o),e.when(this.createNode(n,i,s)).done(function(e){c?o.append(e):o.append(e.wrap("<tr><td"+(l?' colspan="'+2*d.length+'"':"")+"></td></tr>").closest("tr")),a&&a()}).fail(function(){console.log("Failed to creat node")})),l){1===Object.keys(n).length&&(o=t);var h=i+1>=s.depth||n.collapsed?" hidden":"",p=!!(s.verticalDepth&&i+2>=s.verticalDepth);p||o.append('<tr class="lines'+h+'"><td colspan="'+2*d.length+'"><div class="downLine"></div></td></tr>');for(var f='<tr class="lines'+h+'"><td class="rightLine">&nbsp;</td>',g=1;g<d.length;g++)f+='<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>';f+='<td class="leftLine">&nbsp;</td></tr>';var v;p?(v=e("<ul>"),h&&v.addClass(h),i+2===s.verticalDepth?o.append('<tr class="verticalNodes'+h+'"><td></td></tr>').find(".verticalNodes").children().append(v):o.append(v)):(v=e('<tr class="nodes'+h+'">'),o.append(f).append(v)),e.each(d,function(){var t=e(p?"<li>":'<td colspan="2">');v.append(t),r.buildHierarchy(t,this,i+1,s,a)})}},buildChildNode:function(e,t,n,i){var n=n||e.closest(".orgchart").data("options"),s=t.children||t.siblings;e.find("td:first").attr("colspan",2*s.length),this.buildHierarchy(e,{children:s},0,n,i)},addChildren:function(e,t,n){var i=this,n=n||e.closest(".orgchart").data("options"),s=0;this.buildChildNode(e.closest("table"),t,n,function(){++s===t.children.length&&(e.children(".bottomEdge").length||e.append('<i class="edge verticalEdge bottomEdge fa"></i>'),e.find(".symbol").length||e.children(".title").prepend('<i class="fa '+n.parentNodeSymbol+' symbol"></i>'),i.showChildren(e))})},buildParentNode:function(t,n,i,s){var a=this,o=e("<table>");n.relationship=n.relationship||"001",e.when(this.createNode(n,0,i||t.closest(".orgchart").data("options"))).done(function(e){o.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),o.append('<tr class="lines hidden"><td colspan="2"><div class="downLine"></div></td></tr>');o.append('<tr class="lines hidden"><td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td></tr>');var t=a.$chart;t.prepend(o).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children("tr:last").children().append(t.children("table").last()),s()}).fail(function(){console.log("Failed to create parent node")})},addParent:function(e,t,n){var i=this;this.buildParentNode(e,t,n,function(){e.children(".topEdge").length||e.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),i.showParent(e)})},complementLine:function(e,t,n){for(var i="",s=0;s<n;s++)i+='<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*t).end().next().children(":first").after(i)},buildSiblingNode:function(t,n,i,s){var a=this,i=i||t.closest(".orgchart").data("options"),o=n.siblings?n.siblings.length:n.children.length,r=t.parent().is("td")?t.closest("tr").children().length:1,d=r+o,l=d>1?Math.floor(d/2-1):0;if(t.parent().is("td")){t.closest("tr").prevAll("tr:last");t.closest("tr").prevAll("tr:lt(2)").remove();var c=0;this.buildChildNode(t.parent().closest("table"),n,i,function(){if(++c===o){var e=t.parent().closest("table").children("tr:last").children("td");r>1?(a.complementLine(e.eq(0).before(t.closest("td").siblings().addBack().unwrap()),d,r),e.addClass("hidden").find(".node").addClass("slide-left")):(a.complementLine(e.eq(l).after(t.closest("td").unwrap()),d,1),e.not(":eq("+l+"1)").addClass("hidden").slice(0,l).find(".node").addClass("slide-right").end().end().slice(l).find(".node").addClass("slide-left")),s()}})}else{var h=0;this.buildHierarchy(t.closest(".orgchart"),n,0,i,function(){++h===d&&(a.complementLine(t.next().children("tr:last").children().eq(l).after(e('<td colspan="2">').append(t)),d,1),t.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),t.parent().siblings().addClass("hidden").slice(0,l).find(".node").addClass("slide-right").end().end().slice(l).find(".node").addClass("slide-left"),s())})}},addSiblings:function(e,t,n){var i=this;this.buildSiblingNode(e.closest("table"),t,n,function(){e.closest(".nodes").data("siblingsLoaded",!0),e.children(".leftEdge").length||e.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),i.showSiblings(e)})},removeNodes:function(e){var t=e.closest("table").parent(),n=t.parent().siblings();t.is("td")?this.getNodeState(e,"siblings").exist?(n.eq(2).children(".topLine:lt(2)").remove(),n.slice(0,2).children().attr("colspan",n.eq(2).children().length),t.remove()):n.eq(0).children().removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove():t.add(t.siblings()).remove()},export:function(i,s){var a=this;if(i=void 0!==i?i:this.options.exportFilename,s=void 0!==s?s:this.options.exportFileextension,e(this).children(".spinner").length)return!1;var o=this.$chartContainer,r=o.find(".mask");r.length?r.removeClass("hidden"):o.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>');var d=o.addClass("canvasContainer").find(".orgchart:visible").get(0),l="l2r"===a.options.direction||"r2l"===a.options.direction;html2canvas(d,{width:l?d.clientHeight:d.clientWidth,height:l?d.clientWidth:d.clientHeight,onclone:function(t){e(t).find(".canvasContainer").css("overflow","visible").find(".orgchart:visible:first").css("transform","")},onrendered:function(e){if(o.find(".mask").addClass("hidden"),"pdf"===s.toLowerCase()){var r={},d=Math.floor(.2646*e.width),l=Math.floor(.2646*e.height);(r=d>l?new jsPDF("l","mm",[d,l]):new jsPDF("p","mm",[l,d])).addImage(e.toDataURL(),"png",0,0),r.save(i+".pdf")}else{var c="WebkitAppearance"in n.documentElement.style,h=!!t.sidebar,p="Microsoft Internet Explorer"===navigator.appName||"Netscape"===navigator.appName&&navigator.appVersion.indexOf("Edge")>-1;if(!c&&!h||p)t.navigator.msSaveBlob(e.msToBlob(),i+".png");else{var f=".oc-download-btn"+(""!==a.options.chartClass?"."+a.options.chartClass:"");o.find(f).length||o.append('<a class="oc-download-btn'+(""!==a.options.chartClass?" "+a.options.chartClass:"")+'" download="'+i+'.png"></a>'),o.find(f).attr("href",e.toDataURL())[0].click()}}}}).then(function(){o.removeClass("canvasContainer")},function(){o.removeClass("canvasContainer")})}},e.fn.orgchart=function(e){return new s(this,e).init()}});